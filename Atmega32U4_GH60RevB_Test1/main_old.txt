
#include "main.h"
 uint8_t FN=0x00;
 uint8_t r,c;
 //lrow B6 F5 F6 F7 F4 B2
 //row D0 D1 D2 D3 D5
 //col F0 F1 E6 C7 C6 B7 D4 B0 B1 B5 B4 D7 D6 B3
 void initPins(){
 	uint8_t i;
 	 for ( i=0; i<ROWS; i++){
 		    pinMode(rowPins[i],OUTPUT);
 		    digitalWrite(rowPins[i],HIGH);
 		  }
 		  for ( i=0; i<COLS; i++){
 		    pinMode(colPins[i],INPUT);
 		    digitalWrite(colPins[i],HIGH);
 		  }
 }
void matrixLoopClassical(){
	while (1) {
			  for ( r=0; r<ROWS; r++){
					    digitalWrite(rowPins[r],LOW);
					    for ( c=0; c<COLS; c++){
					      if ( digitalRead(colPins[c]) == LOW)
					      {
					    	 if(keytype[r][c]==0x01) {
					    		 if(FN==0x00)presskey(hexaKeys[r][c]);
					    		 else if(FN==0x01)presskey(hexaKeys2[r][c]);
					    	 }
					    	 else if(keytype[r][c]==0x02){ pressModifierKeys(hexaKeys[r][c]);}
					    	 else if(keytype[r][c]==0x04 && FN==0x00) {FN=0x02;}
					      }
					  else{
						  if(keytype[r][c]==0x01){
							  if(FN==0x00)  releasekey(hexaKeys[r][c]);
							  else if(FN==0x01)  releasekey(hexaKeys2[r][c]);
						  }
						  else if(keytype[r][c]==0x02) {releaseModifierKeys(hexaKeys[r][c]);}
						  else if(keytype[r][c]==0x04 && FN==0x01) {FN=0x04;}
					  }
					  }
	    digitalWrite(rowPins[r],HIGH);
			  }
			  if(FN==0x02){FN=0x01;releaseAll();}
			  else if(FN==0x04){FN=0x00;releaseAll();}
			  usb_keyboard_send();
		}
 }
int main(void)
{
	CPU_PRESCALE(CPU_16MHz);
	usb_init();
	while (!usb_configured()) /* wait */
	_delay_ms(1000);

	initPins();
    //  TCCR0A = 0x00;
    //	TCCR0B =(1<<CS00);
    //	TIMSK0 = (1<<TOIE0);
////////////////////////////////////////////////
	  matrixLoopClassical();
	///////////////////////////////////
return 0;}
/*
ISR(TIMER0_OVF_vect)
{

}
*/
